

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Spike Wong">
  <meta name="keywords" content="">
  
    <meta name="description" content="This article mainly records that how a query sql works, MySQL Architecture and Layers.Here is the flow chart.    视频版本选择–5.7.x1select version();  -- you can see the version     MySQL 通信协议通讯类型——同步&amp;异">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL - Execution Flow &amp; Architecture">
<meta property="og:url" content="https://iceswear.github.io/2022/11/22/MySQL-Execution-Flow-Architecture/index.html">
<meta property="og:site_name" content="IsEmpty">
<meta property="og:description" content="This article mainly records that how a query sql works, MySQL Architecture and Layers.Here is the flow chart.    视频版本选择–5.7.x1select version();  -- you can see the version     MySQL 通信协议通讯类型——同步&amp;异">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://iceswear.github.io/2022/11/22/MySQL-Execution-Flow-Architecture/1668591518821-973d9ec3-03c1-44a2-a23d-c42221408b16.png">
<meta property="og:image" content="https://iceswear.github.io/2022/11/22/MySQL-Execution-Flow-Architecture/1669108141790-c79688f6-8c38-45f5-b2b6-40b7a4ef8daa.png">
<meta property="og:image" content="https://iceswear.github.io/2022/11/22/MySQL-Execution-Flow-Architecture/1668589755774-3f005eae-3b86-42a4-94b7-69775452b65a.png">
<meta property="og:image" content="https://iceswear.github.io/2022/11/22/MySQL-Execution-Flow-Architecture/1668581816297-7b6677df-43d0-495c-ae6c-67de5711f2ec.png">
<meta property="og:image" content="https://iceswear.github.io/2022/11/22/MySQL-Execution-Flow-Architecture/1668760214168-0b45b29f-b5ed-48d2-a20c-d09073c335a1.png">
<meta property="article:published_time" content="2022-11-22T09:17:54.000Z">
<meta property="article:modified_time" content="2022-12-17T07:47:36.964Z">
<meta property="article:author" content="Spike Wong">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://iceswear.github.io/2022/11/22/MySQL-Execution-Flow-Architecture/1668591518821-973d9ec3-03c1-44a2-a23d-c42221408b16.png">
  
  
  
  <title>MySQL - Execution Flow &amp; Architecture - IsEmpty</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"iceswear.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"gNT0GKJvKRzpcF3HJY1HBPjS-gzGzoHsz","app_key":"W8wiPGjZqDBSYGZprgHt8Ioh","server_url":"https://gnt0gkjv.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>IsEmpty</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="MySQL - Execution Flow &amp; Architecture"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-11-22 17:17" pubdate>
          November 22, 2022 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9.1k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          77 mins
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> views
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">MySQL - Execution Flow &amp; Architecture</h1>
            
            
              <div class="markdown-body">
                
                <p>This article mainly records that how a query sql works, MySQL Architecture and Layers.Here is the flow chart.</p>
<p><img src="1668591518821-973d9ec3-03c1-44a2-a23d-c42221408b16.png" srcset="/img/loading.gif" lazyload alt="Flow Chart"></p>
<p><img src="1669108141790-c79688f6-8c38-45f5-b2b6-40b7a4ef8daa.png" srcset="/img/loading.gif" lazyload alt="Architecture"></p>
<hr>
<h4 id="视频版本选择–5-7-x"><a href="#视频版本选择–5-7-x" class="headerlink" title="视频版本选择–5.7.x"></a>视频版本选择–5.7.x</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> version();  <span class="hljs-comment">-- you can see the version</span><br></code></pre></td></tr></table></figure>



<hr>
<h4 id="MySQL-通信协议"><a href="#MySQL-通信协议" class="headerlink" title="MySQL 通信协议"></a>MySQL 通信协议</h4><h5 id="通讯类型——同步-amp-异步"><a href="#通讯类型——同步-amp-异步" class="headerlink" title="通讯类型——同步&amp;异步"></a>通讯类型——同步&amp;异步</h5><p>一般来说，客户端连接数据库都是同步连接的</p>
<p><strong>同步</strong>的比较多，简单一些；<strong>异步</strong>编程难度较大。</p>
<hr>
<h5 id="连接方式——长连接-amp-短连接"><a href="#连接方式——长连接-amp-短连接" class="headerlink" title="连接方式——长连接&amp;短连接"></a>连接方式——长连接&amp;短连接</h5><p>Client，Terminal，Connector &amp; etc.</p>
<p><strong>短连接：</strong>即用即连，用完就关</p>
<p><strong>长连接：</strong>连接池，会消耗内存</p>
<p>一般来说都是<strong>长连接</strong>，而且会把这个连接放到客户端的连接池。</p>
<p>E.g.：淘宝早起用LAMP-PHP连MySQL——参考《淘宝技术这10年》</p>
<p>MySQL中查看线程数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> <span class="hljs-keyword">global</span> status <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;Thread%&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>Result 结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">Threads_cached	   缓存中的线程连接数<br>Threads_connected	 当前打开的连接数<br>Threads_created	   为处理连接创建的线程数<br>Threads_running	   非睡眠状态的连接数，通常指并发连接数<br></code></pre></td></tr></table></figure>



<hr>
<p>查看超时&amp;最大连接数</p>
<p>Timeout 超时时间</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> <span class="hljs-keyword">global</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;wait_timeout&#x27;</span>;  <span class="hljs-comment">-- 非交互式超时时间，如jdbc</span><br><span class="hljs-keyword">show</span> <span class="hljs-keyword">global</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;interactive_timeout&#x27;</span>;  <span class="hljs-comment">--交互式超时时间，如数据库工具</span><br></code></pre></td></tr></table></figure>

<p>默认都是28800秒，8 小时。</p>
<hr>
<p>查看最大连接数 Max Connections </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;max_connections&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>默认最大连接数为151。实际可以到100k</p>
<h5 id="修改连接数"><a href="#修改连接数" class="headerlink" title="修改连接数"></a>修改连接数</h5><ol>
<li>动态临时修改，服务器重启后会恢复</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> <span class="hljs-keyword">global</span> max_connections<span class="hljs-operator">=</span> ;<br><span class="hljs-keyword">set</span> autocommit <span class="hljs-operator">=</span><span class="hljs-keyword">on</span>;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>永久修改</li>
</ol>
<p>修改**/etc/my.cnf 或 my.ini**</p>
<p>*两种参数级别</p>
<ol>
<li><strong>GLOBAL 全局</strong></li>
<li><strong>SESSION</strong> 当前会话窗口 (不带级别，默认SESSION)</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 自动提交 事务</span><br><span class="hljs-keyword">show</span> VARIABLES <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;autocommit&#x27;</span>; <br><br><span class="hljs-keyword">set</span> autocommit<span class="hljs-operator">=</span> <span class="hljs-keyword">on</span>;<br></code></pre></td></tr></table></figure>

<p>官网手册</p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/">https://dev.mysql.com/doc/refman/5.7/en/</a></p>
<hr>
<h5 id="通讯协议"><a href="#通讯协议" class="headerlink" title="通讯协议"></a>通讯协议</h5><ol>
<li><strong>TCP/IP</strong></li>
</ol>
<p>如果指定-h 参数，就会用TCP/IP协议</p>
<p>编程语言的连接模块都是用 TCP 协议连接到 MysQL 服务器的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql <span class="hljs-operator">-</span>h<span class="hljs-operator">*</span>.<span class="hljs-operator">*</span>.<span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-operator">-</span>uroot <span class="hljs-operator">-</span>p<br></code></pre></td></tr></table></figure>

<ol start="2">
<li><strong>Unix Socket</strong></li>
</ol>
<p>类似于之前Linux安装多个mysql时用的，在Linux服务器上，如果没有指定-h参数，它就用socket方式登录。它不用通过网络协议，也可以连接到MySQL的服务器，它需要用到服务器上的一个物理文件(/var/lib/mysql/mysql.sock)</p>
<hr>
<h5 id="通信方式"><a href="#通信方式" class="headerlink" title="通信方式"></a>通信方式</h5><ol>
<li><strong>单工：</strong>数据单向传输</li>
</ol>
<p>在两台计算机通信的时候，数据的传输是单向的。</p>
<p>生活中的类比：遥控器。</p>
<ol start="2">
<li><strong>半双工：</strong>数据双向传输，但不能同时传输 </li>
</ol>
<p><strong>MySQL 使用了半双工的通信方式。</strong></p>
<p>生活中的类比：对讲机。</p>
<ol start="3">
<li><strong>全双工：</strong>数据双向传输，可以同时传输</li>
</ol>
<p>生活中的类比：打电话。</p>
<p>SQL语句默认不超过 4MB，4194304</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> <span class="hljs-keyword">global</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;max_allowed_packet&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>对于服务端来说，也是一次性发送所有的数据，不能因为你已经取到了想 要的数据就中断操作，这个时候会对网络和内存产生大量消耗。</p>
<p>所以，在程序里面要避免不带<strong>limit</strong> 的这种操作，比如一次把所有满足条件的数据全 部查出来，<strong>一定要先count一下</strong>。如果数据量的话，可以分批查询。</p>
<hr>
<h2 id="查询缓存-Query-Cache"><a href="#查询缓存-Query-Cache" class="headerlink" title="查询缓存 Query Cache"></a>查询缓存 Query Cache</h2><p>查询缓存，默认关闭。</p>
<p>Query cache, default status is closed.</p>
<p>作用帮助不大，缓存这一块，还是交给ORM框架，或者独立的缓存服务，比如Redis等来处理更合适。<strong>在My SQL 8. 0 中，查询缓存功能已经被移除了。</strong></p>
<p>The function is not very helpful, usually we will use ORM framework or some other independent cache server like redis to deal with. From 8.0 or futher version, the cache query function is removed.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;query_cache%&#x27;</span>;<br></code></pre></td></tr></table></figure>





<h2 id="Parser-amp-Pre-processor-语法解析和预处理"><a href="#Parser-amp-Pre-processor-语法解析和预处理" class="headerlink" title="Parser &amp; Pre-processor 语法解析和预处理"></a>Parser &amp; Pre-processor 语法解析和预处理</h2><ol>
<li><strong>词法解析</strong></li>
</ol>
<p>将单词打碎成一个个单词，逐个解析，进行词法分析。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> name <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> ;<br></code></pre></td></tr></table></figure>

<p>它会打碎成8个符号，每个符号是什么类型，从哪里开始到哪里结束。</p>
<ol start="2">
<li><strong>语法解析</strong></li>
</ol>
<p>语法分析会对SQL做一些语法检查，比如单引号有没有闭合，然后根据MySQL定义的语法规则，根据SQL语句生成一个数据结构——<strong>解析树 (select_lex)。</strong></p>
<p>编写一个自己的连接池的中间件，也要实现这些功能。</p>
<p><img src="1668589755774-3f005eae-3b86-42a4-94b7-69775452b65a.png" srcset="/img/loading.gif" lazyload alt="select_lex"></p>
<ol start="3">
<li><strong>预处理器</strong></li>
</ol>
<p>语义解析：检查生成的解析树，解决解析器无法解析的语义，如<strong>是否存在该表，该数据库等</strong></p>
<p>权限：检查<strong>是否有权限执行</strong>该语句</p>
<p><strong>预处理之后得到一个新的解析树。</strong></p>
<hr>
<h2 id="Query-Optimizer-amp-Execution-plans-查询优化与查询执行计划"><a href="#Query-Optimizer-amp-Execution-plans-查询优化与查询执行计划" class="headerlink" title="Query Optimizer&amp; Execution plans 查询优化与查询执行计划"></a>Query Optimizer&amp; Execution plans 查询优化与查询执行计划</h2><h5 id="优化器-Optimizer"><a href="#优化器-Optimizer" class="headerlink" title="优化器 Optimizer"></a>优化器 Optimizer</h5><p>一条SQL语句是可以有很多种执行方式的，最终返回相同的结果，他们是等价的。</p>
<p>查询优化器的目的就是根据<strong>解析树</strong>生成不同的执行计划(Execution Plan) ，然后选择一种最优的执行计划，MySQL里面使用的是基于开销（cost）的优化器，那种<strong>执行计划开销最小</strong>，就用哪种。</p>
<p><strong>Cost Based Optimizer CBO优化器</strong></p>
<p>查看查询开销</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> status <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;Last_query_cost&#x27;</span>;<br></code></pre></td></tr></table></figure>



<p>优化器可以做什么</p>
<ol>
<li>以哪张表为<strong>基准表</strong></li>
<li>有多个素引可以使用的时候，<strong>选择哪个索引</strong></li>
<li>对于<strong>查询条件的优化</strong>，比如移除1=1之类的恒等式，移除不必要的括号，表达式的计算，子查询和连接查询的优化。</li>
</ol>
<h5 id="执行计划-execution-plans"><a href="#执行计划-execution-plans" class="headerlink" title="执行计划 execution plans"></a>执行计划 execution plans</h5><p>优化器最终会把解析树变成一个执行计划(execution plans)，执行计划也是一个数据结构。</p>
<p>MysQL提供了一个执行计划的工具。我们在SQL语向前面加 上EXPLAIN，就可以 看到执行计划的信息。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">EXPLAIN <span class="hljs-keyword">select</span> name <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>





<hr>
<h2 id="存储引擎Storage-Engine"><a href="#存储引擎Storage-Engine" class="headerlink" title="存储引擎Storage Engine"></a>存储引擎Storage Engine</h2><p>在MySQL里面，支持多种存储引擎，他们是可以替换的，所以叫做插件式的存储引擎。</p>
<p>MySQL can support various kinds of storage engines, they can be replaced by each other, hence the engines are also called as pluggable storage enginees.</p>
<p>查看数据库的存储引擎</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> <span class="hljs-keyword">table</span> status <span class="hljs-keyword">from</span> 数据库名;<br></code></pre></td></tr></table></figure>

<p>查看存储引擎</p>
<p>See storage engine</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> engines;<br></code></pre></td></tr></table></figure>

<h2 id="MySQL-5-7-Supported-Storage-Engines"><a href="#MySQL-5-7-Supported-Storage-Engines" class="headerlink" title="MySQL 5.7 Supported Storage Engines"></a>MySQL 5.7 Supported Storage Engines</h2><ul>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-storage-engine.html">InnoDB</a>: The default storage engine in MySQL 5.7. InnoDB is a transaction-safe (ACID compliant) storage engine for MySQL that has commit, rollback, and crash-recovery capabilities to protect user data. InnoDB row-level locking (without escalation to coarser granularity locks) and Oracle-style consistent nonlocking reads increase multi-user concurrency and performance. InnoDB stores user data in clustered indexes to reduce I/O for common queries based on primary keys. To maintain data integrity, InnoDB also supports FOREIGN KEY referential-integrity constraints. For more information about InnoDB, see <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-storage-engine.html">Chapter 14,The InnoDB Storage Engine</a>.</li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/myisam-storage-engine.html">MyISAM</a>: These tables have a small footprint. <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_table_lock">Table-level locking</a> limits the performance in read/write workloads, so it is often used in read-only or read-mostly workloads in Web and data warehousing configurations.</li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/memory-storage-engine.html">Memory</a>（内存存储，快，易丢失）: Stores all data in RAM, for fast access in environments that require quick lookups of non-critical data. This engine was formerly known as the HEAP engine. Its use cases are decreasing; InnoDB with its buffer pool memory area provides a general-purpose and durable way to keep most or all data in memory, and NDBCLUSTER provides fast key-value lookups for huge distributed data sets.</li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/csv-storage-engine.html">CSV</a>（容易解析，快）: Its tables are really text files with comma-separated values. CSV tables let you import or dump data in CSV format, to exchange data with scripts and applications that read and write that same format. Because CSV tables are not indexed, you typically keep the data in InnoDB tables during normal operation, and only use CSV tables during the import or export stage.</li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/archive-storage-engine.html">Archive</a>(归档不动的数据，易压缩): These compact, unindexed tables are intended for storing and retrieving large amounts of seldom-referenced historical, archived, or security audit information.</li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/blackhole-storage-engine.html">Blackhole</a>: The Blackhole storage engine accepts but does not store data, similar to the Unix /dev/null device. Queries always return an empty set. These tables can be used in replication configurations where DML statements are sent to replica servers, but the source server does not keep its own copy of the data.</li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/mysql-cluster.html">NDB</a> (also known as <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/mysql-cluster.html">NDBCLUSTER</a>): This clustered database engine is particularly suited for applications that require the highest possible degree of uptime and availability.</li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/merge-storage-engine.html">Merge</a>: Enables a MySQL DBA or developer to logically group a series of identical MyISAM tables and reference them as one object. Good for VLDB environments such as data warehousing.</li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/federated-storage-engine.html">Federated</a>: Offers the ability to link separate MySQL servers to create one logical database from many physical servers. Very good for distributed or data mart environments.</li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/example-storage-engine.html">Example</a>: This engine serves as an example in the MySQL source code that illustrates how to begin writing new storage engines. It is primarily of interest to developers. The storage engine is a “stub” that does nothing. You can create tables with this engine, but no data can be stored in them or retrieved from them.</li>
</ul>
<p>You are not restricted to using the same storage engine for an entire server or schema. You can specify the storage engine for any table. For example, an application might use mostly InnoDB tables, with one CSV table for exporting data to a spreadsheet and a few MEMORY tables for temporary workspaces.</p>
<p>不同的所属引擎，有不同的特性，根据实际业务需求进行切换。不同的表可以切换不同的存储引擎。修改存储引擎会锁表，不要在生产环境中进行操作。</p>
<hr>
<p>查看数据存储位置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;datadir&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>可以看到存储引擎不同，底层文件不一样</p>
<p><img src="1668581816297-7b6677df-43d0-495c-ae6c-67de5711f2ec.png" srcset="/img/loading.gif" lazyload alt="Files"></p>
<p>任何一个存储引擎都有一个frm文件，这个是表结构定义文件。不同的存储引擎存放数据的方式不一样，产生的文件也不一样，InnoDB是1个，MEMORY没有，MyISAM是两个。</p>
<p>存储引擎就是我们的数据真正存放的地方，在MySQL里面支持不同的存储引擎。再往下就是文件管理系统，内存或者磁盘。</p>
<h5 id="执行引擎-Execution-Engine"><a href="#执行引擎-Execution-Engine" class="headerlink" title="执行引擎 Execution Engine"></a>执行引擎 Execution Engine</h5><p>所有的存储引擎，都要根据规范，<strong>开放接口</strong>给执行器进行操作执行。</p>
<p>执行器利用存储引擎提供的相应的API来完成操作。</p>
<p>No matter whichever engine you choose to use, execution engine can run.</p>
<hr>
<h4 id="顺序I-O-VS-随机I-O"><a href="#顺序I-O-VS-随机I-O" class="headerlink" title="顺序I/O VS 随机I/O"></a>顺序I/O VS 随机I/O</h4><p><strong>顺序IO：</strong>不需要重新寻址，比较快速地拿到数据，效率高；由于地址是连贯的，找到地址后，一次可以读写许多数据，效率比较高。</p>
<p><strong>随机IO：</strong>会将数据随机分散在磁盘不同也得不同扇区，读取数据速度较慢。需要先找到地址，再读写数据，每次拿到的地址都是随机的。</p>
<p>刷盘是随机I/O，而记录日志是顺序I/O（连续写的），顺序I/O效率更高。因此先把修改写入日志文件，在保证了内存数据的安全性的情况下，可以延迟刷盘时机，进而提升系统吞吐。</p>
<h2 id="缓冲池-Buffer-Pool"><a href="#缓冲池-Buffer-Pool" class="headerlink" title="缓冲池 Buffer Pool"></a>缓冲池 Buffer Pool</h2><p>因为数据库需要频繁对磁盘进行 IO 操作，为了改善因为直接读写磁盘导致的 IO 性能问题，所以引入了缓冲池。</p>
<p>InnoDB设定了一个存储引擎从磁盘读取数据到内存的最小的单位，叫做页。操作系统也有页的概念。<strong>操作系统的页大小一般是4K(局部性原理)<strong>，而在InnoDB里面，这个最小的单位默认是 <strong>16KB</strong> 大小，它是一个逻辑单位。如果要修改这个值的大小，</strong>必须修改源码重新编译安装</strong>。</p>
<p>InnoDB使用了一种缓冲池的技术，也就是把磁盘读到的页放到一块内存区域里面。 下一次读取相同的页，先判断是不是在这个内存区域里面，如果是，就直接读取，然后操作，不用再次从磁盘加载。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> STATUS <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%innodb_buffer_pool%&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>Buffer Pool默认大小是128M (134217728字节)，可以调整。</p>
<p><img src="1668760214168-0b45b29f-b5ed-48d2-a20c-d09073c335a1.png" srcset="/img/loading.gif" lazyload alt="redo log"></p>
<p>修改数据的时候，先修改内存缓冲池里面的页。内存的数据页和磁盘数据不一致的时候，我们把它叫做<strong>脏页</strong>。那脏页什么时候同步到磁盘呢? InnoDB里面有专门的<strong>后台线程</strong>把Buffer Pool的数据写入到磁盘，<strong>每隔一段时间就一次性地把多个修改写入磁盘，这个动作就叫做刷脏。</strong></p>
<p><strong>PS：</strong>刷脏页的过程是异步的，这样更新操作就不需要等待磁盘的 IO 操作了。因此这些特点极大地提升了 InnoDB 的性能。</p>
<hr>
<h2 id="redo-Log-Buffer"><a href="#redo-Log-Buffer" class="headerlink" title="(redo) Log Buffer"></a>(redo) Log Buffer</h2><p>因为刷脏不是实时的，如果Buffer Pool 里面的脏页还没有刷入磁盘时，数据库宕机或者重启，这些数据就会丢失。</p>
<p>所以，内存的数据必须要有一个持久化的措施。</p>
<p>InnoDB 把所有对页面的修改操作专门写入一个日志文件。</p>
<p>如果有未同步到磁盘的数据，数据库在启动的时候，会从这个日志文件进行恢复操作 (实现crash-safe) 。 我们说的事务的ACID里面D（持久性），就是用它来实现的。</p>
<p><strong>WAL（Write-Ahead Logging，日志先行）</strong> 。即：事务提交前先写日志，再修改页（修改页的时机就是刷脏页的时机）。这里所谓的日志，就是 磁盘的redo log（重做日志），默认2个文件，每个文件48M</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;innodb_log%&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>除了redolog之外，还有一个跟修改有关的日志，叫做undolog.redo.log 和 undo.log 与事务密切相关，统称为事务日志。</p>
<p>在写 redo log 时会先写 redo log buffer，并在以下时机将 redo log 刷新到磁盘：</p>
<ul>
<li>每秒刷新一次</li>
<li>事务提交时</li>
<li>redo log buffer 剩余空间小于 1/2 时</li>
</ul>
<h4 id="Feature-Of-redo-log-特点"><a href="#Feature-Of-redo-log-特点" class="headerlink" title="Feature Of redo log  特点"></a>Feature Of redo log  特点</h4><ol>
<li>redo log 是InnoDB存储引擎实现的，并不是所有存储引擎都有，<strong>支持崩溃恢复是InnoDB的一个特性</strong>；</li>
<li>redo log 是<strong>物理日志</strong>，记录的事“在某个数据页上做了什么修改”；</li>
<li>redo log 的大小是固定的，前面的内容会被覆盖，一旦写满，就会触发buffer pool到磁盘的同步，一边腾出空间记录后面的修改。默认是48M</li>
</ol>
<p>除了redo log，还有一个跟修改有关的日志，叫做undo log（逻辑日志）。redo log和undo log 与事务密切相关，统称为事务日志。</p>
<p>undo log (撤销日志或回滚日志)记录了事务发生之前的数据状态(不包括select)。如果修改数据时出现异常，可以用undo log 来实现回滚操作（保持原子性，ACID的A）。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> <span class="hljs-keyword">global</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%undo%&#x27;</span>;<br></code></pre></td></tr></table></figure>



<hr>
<h4 id="后台线程"><a href="#后台线程" class="headerlink" title="后台线程"></a>后台线程</h4><p>后台线程的主要作用是负责刷新内存是中的数据和把修改的数据页刷新到磁盘，后台线程分为：master thread , IO thread（主服务器数据发给从服务器）, purge thread（刷脏的）, page cleaner thread（清除缓存）。</p>
<hr>
<h4 id="binlog"><a href="#binlog" class="headerlink" title="binlog"></a>binlog</h4><p>MySQL的Server层也有一个日志文件，叫做binlog，可以被所有的存储引擎使用，默认是关闭的。</p>
<p>binlog 是 MySQL 服务器层面实现的一种二进制日志，用于记录所有对数据库的更改操作（这种日志被称为逻辑日志）。</p>
<p>一般我们会将 binlog 用于以下几个方面：</p>
<ol>
<li><strong>主从复制：</strong>MySQL 从服务器可以通过订阅 binlog 实现对主服务器的增量复制。</li>
<li><strong>审计：</strong>通过对 binlog 中的数据进行审计，判断是否存在安全问题，比如 SQL 注入。</li>
<li><strong>数据库增量备份与恢复：</strong>在使用备份还原数据后，可以使用 binlog 中记录的内容对备份时间点（简称备份点）后的数据进行恢复。因为 binlog 会还会记录下更改操作的时间，所以 binlog 可以恢复到某一具体时间点的数据。这就为我们删库后提供了除跑路以外的第二个选项：使用 binlog 恢复数据。</li>
</ol>
<p><strong>使用 binlog 进行恢复的流程是：</strong></p>
<ol>
<li>先通过最新的备份恢复数据库的全量数据，并记录下备份文件备份的时间点；</li>
<li>在 binlog 中找到这个时间点，提取这个时间点以后的数据用于实现对备份点后数据的恢复（这个特性被称为 Point in Time，简称 PIT）。</li>
</ol>
<p><strong>有 binlog 为什么还要 redo log ？</strong></p>
<ol>
<li>binlog 不知道数据库究竟是在哪一时刻丢失了哪部分数据，只能从备份点开始对 binlog 记录重放来恢复数据，比较耗时。</li>
<li>binlog 恢复是需要我们手动执行的，而 redo log 可以在服务器重启后自动恢复数据。</li>
<li>WAL + 先写缓冲 + 异步刷脏页有效提升了磁盘的 IO 效率。</li>
</ol>
<p><strong>有 redo log 为什么还要 binlog？</strong></p>
<ol>
<li>binlog 是服务器层面的功能，redo log 是 innoDB 的功能。redo log 帮助 InnoDB 实现了性能提升、自动恢复。但其他存储引擎是无法使用 redo log 的能力的。</li>
<li>我们也可以关闭 binlog，但大多数情况下我们都会开启，因为开启的好处更多。比如，主从模式需要订阅 binlog 进行主从复制，以及可以通过 binlog 进行数据库的增量备份和恢复。</li>
</ol>
<p>redo log 有很多好处，所以我们不能放弃；binlog 也有很多好处，我们也不能放弃。</p>
<p>也就是说，这两个功能我们都需要开启。</p>
<p>既然都要开启，那么 我们必须保证 redo log 和 binlog 数据的一致性。 如果 binlog 有 redo log 没有，那么 redo log 宕机自动恢复时的数据就会缺少；反之，redo log 有，binlog 没有，如果开启了主从模式，主服务器因为 redo log 恢复了数据，但从服务器靠消费 binlog 保证和主服务器数据一致，这就导致从服务器比主服务器数据少。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.51cto.com/article/717149.html">https://www.51cto.com/article/717149.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.rathishkumar.in/2016/04/understanding-mysql-architecture.html">https://www.rathishkumar.in/2016/04/understanding-mysql-architecture.html</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/MySQL/" class="category-chain-item">MySQL</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/MySQL/">#MySQL</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>MySQL - Execution Flow &amp; Architecture</div>
      <div>https://iceswear.github.io/2022/11/22/MySQL-Execution-Flow-Architecture/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Spike Wong</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>November 22, 2022</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/10/Quick_Start_A_JEECG_DEMO/" title="Quick Start A JEECG DEMO">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Quick Start A JEECG DEMO</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/11/15/Review-MySQL-Definitions-Schemas/" title="Review MySQL - Definitions&amp;Schemas">
                        <span class="hidden-mobile">Review MySQL - Definitions&amp;Schemas</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"gNT0GKJvKRzpcF3HJY1HBPjS-gzGzoHsz","appKey":"W8wiPGjZqDBSYGZprgHt8Ioh","path":"window.location.pathname","placeholder":"Say something?","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"en","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://space.bilibili.com/9471506" target="_blank" rel="nofollow noopener"><span>Bilibili</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/IceSwear" target="_blank" rel="nofollow noopener"><span>Github</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        Views: 
        <span id="leancloud-site-pv"></span>
        
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        Visitors: 
        <span id="leancloud-site-uv"></span>
        
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
